name: Deploy to EC2

on:
  workflow_dispatch:

env:
  FASTAPI_DIR: apps/backend
  NEXTJS_DIR: apps/frontend
  DEPLOY_PATH: /var/www/myapp

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts || echo "Warning: ssh-keyscan failed, continuing..."

      - name: Copy application files
        run: |
          rsync -avz --delete \
            --exclude 'node_modules' \
            --exclude '.next' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude 'venv' \
            --exclude '.venv' \
            --exclude '.git' \
            -e "ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ env.DEPLOY_PATH }}/

      - name: Setup packages and dependencies
        env:
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "export DEPLOY_PATH=$DEPLOY_PATH && bash $DEPLOY_PATH/.github/scripts/setup-packages.sh"

      - name: Setup FastAPI Backend
        env:
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
          FASTAPI_DIR: ${{ env.FASTAPI_DIR }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_NAME: ${{ secrets.DB_NAME }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "export DEPLOY_PATH=$DEPLOY_PATH FASTAPI_DIR=$FASTAPI_DIR DB_USER='$DB_USER' DB_PASSWORD='$DB_PASSWORD' DB_HOST=$DB_HOST DB_NAME=$DB_NAME SECRET_KEY='$SECRET_KEY' && bash $DEPLOY_PATH/.github/scripts/setup-fastapi.sh"

      - name: Setup Next.js Frontend
        env:
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
          NEXTJS_DIR: ${{ env.NEXTJS_DIR }}
          DOMAIN: ${{ secrets.DOMAIN }}
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "export DEPLOY_PATH=$DEPLOY_PATH NEXTJS_DIR=$NEXTJS_DIR DOMAIN=$DOMAIN && bash $DEPLOY_PATH/.github/scripts/setup-nextjs.sh"

      - name: Setup systemd services
        env:
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
          FASTAPI_DIR: ${{ env.FASTAPI_DIR }}
          NEXTJS_DIR: ${{ env.NEXTJS_DIR }}
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "export DEPLOY_PATH=$DEPLOY_PATH FASTAPI_DIR=$FASTAPI_DIR NEXTJS_DIR=$NEXTJS_DIR USER=\$USER && bash $DEPLOY_PATH/.github/scripts/setup-systemd.sh"

      - name: Configure Caddy reverse proxy
        env:
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
          EMAIL: ${{ secrets.EMAIL }}
          DOMAIN: ${{ secrets.DOMAIN }}
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "export DEPLOY_PATH=$DEPLOY_PATH EMAIL=$EMAIL DOMAIN=$DOMAIN && bash $DEPLOY_PATH/.github/scripts/setup-caddy.sh"

      - name: Check deployment status
        env:
          DOMAIN: ${{ secrets.DOMAIN }}
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "export DOMAIN=$DOMAIN && bash ${{ env.DEPLOY_PATH }}/.github/scripts/check-deployment.sh"

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/id_ed25519